property cnc ${cnc:map("target/nukleus-itests/tcp/cnc", 1024, 1024)}

connect agrona://stream/bidirectional
        option reader ${agrona:broadcastReceiver(cnc.controller)}
        option writer ${agrona:manyToOneWriter(cnc.nukleus)}

connected

write [0x00 0x00 0x00 0x01]
write ${cnc.nextCorrelationId()}
write [0x06] "source"
write [0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00]
write [0x0b] "destination"
write [0x01] [0x7f 0x00 0x00 0x01]
write [0x1f 0x90]
write flush

read [0x40 0x00 0x00 0x01]
read ${cnc.correlationId()}
read ([0..8]:bindingRef)

write [0x00 0x00 0x00 0x02]
write ${cnc.nextCorrelationId()}
write ${bindingRef}
write flush

read [0x40 0x00 0x00 0x02]
read ${cnc.correlationId()}
read [0x06] "source"
read [0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00]
read [0x0b] "destination"
read [0x01] [0x7f 0x00 0x00 0x01]
read [0x1f 0x90]

close
closed
